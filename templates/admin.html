<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Amtsilati Store</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 2em; background-color: #f4f4f9; }
        h1, h2, h3 { color: #333; }
        .container { background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2em; }
        form { display: flex; flex-direction: column; gap: 1em; }
        label { font-weight: bold; }
        input, select, button { padding: 0.8em; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        a.button { display: inline-block; padding: 0.8em; text-decoration: none; border-radius: 4px; color: white; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 0.8em; text-align: left; vertical-align: middle; }
        .table-image { width: 60px; height: 80px; object-fit: cover; border-radius: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2em; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .close-button { float: right; font-size: 1.5em; cursor: pointer; }
        .btn-group { display: flex; }
        .btn-group .button { border-radius: 0; flex-grow: 1; }
        .btn-group .button:first-child { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
        .btn-group .button:last-child { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .btn-edit { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        #message { margin-top: 1em; padding: 1em; border-radius: 4px; display: none; }
        #message.success { background-color: #d4edda; color: #155724; }
        #message.error { background-color: #f8d7da; color: #721c24; }
        .select2-container { width: 100% !important; }
        .select2-container .select2-selection--single { height: auto !important; padding: 0.5em; }
    </style>
</head>
<body>
    <h1>Dashboard Admin</h1>
    <div style="text-align: right; margin-bottom: 1em;"><a href="{{ url_for('logout') }}" class="button btn-danger">Logout</a></div>
    <div id="message"></div>

    <!-- Manajemen Kitab -->
    <div class="container">
        <h2>Manajemen Kitab</h2>
        <form id="add-book-form" enctype="multipart/form-data">
            <label for="book-name">Nama Kitab:</label>
            <input type="text" id="book-name" name="name" required>
            <label for="book-price">Harga Kitab (angka saja):</label>
            <input type="number" id="book-price" name="price" required>
            <label for="book-availability">Ketersediaan:</label>
            <select id="book-availability" name="availability" required>
                <option value="Tersedia">Tersedia</option>
                <option value="Tidak Tersedia">Tidak Tersedia</option>
            </select>
            <label for="book-link-ig">Link Instagram:</label>
            <input type="url" id="book-link-ig" name="link_ig" placeholder="https://instagram.com/...">
            <label for="book-link-wa">Link WhatsApp:</label>
            <input type="url" id="book-link-wa" name="link_wa" placeholder="https://wa.me/...">
            <label for="book-link-shopee">Link Shopee:</label>
            <input type="url" id="book-link-shopee" name="link_shopee" placeholder="https://shopee.co.id/...">
            <label for="book-link-tiktok">Link TikTok:</label>
            <input type="url" id="book-link-tiktok" name="link_tiktok" placeholder="https://tiktok.com/...">
            <label for="book-image">Foto Kitab:</label>
            <input type="file" id="book-image" name="image" accept="image/png, image/jpeg, image/webp">
            <button type="submit">Tambah Kitab Baru</button>
        </form>
    </div>

    <!-- Daftar Kitab Saat Ini -->
    <div class="container">
        <h3>Daftar Kitab Saat Ini</h3>
        <div style="overflow-x: auto;">
            <table id="books-table">
                <thead>
                    <tr>
                        <th>Gambar</th>
                        <th>Nama Kitab</th>
                        <th>Harga</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="books-table-body"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Data Pembeli Offline -->
    <div class="container">
        <h2>Data Pembeli Offline</h2>
        <form id="import-form">
            <label for="excel-file">Import Data Pembeli dari Excel (.xlsx):</label>
            <input type="file" id="excel-file" name="file" accept=".xlsx" required>
            <button type="submit">Import</button>
        </form>
    </div>

    <!-- Rekap Pembelian Offline -->
    <div class="container">
        <h2>Rekap Pembelian Offline</h2>
        <form id="offline-sale-form">
            <label for="offline-buyer">Nama Pembeli:</label>
            <select id="offline-buyer" name="buyer_id" required></select>
            <label for="offline-book">Kitab:</label>
            <select id="offline-book" name="book_id" required></select>
            <label for="offline-price">Harga (otomatis):</label>
            <input type="text" id="offline-price" disabled>
            <label for="offline-quantity">Jumlah:</label>
            <input type="number" id="offline-quantity" name="quantity" min="1" value="1" required>
            <button type="submit">Tambah Rekap</button>
        </form>
    </div>

    <!-- Rekap Pembelian Online -->
    <div class="container">
        <h2>Rekap Pembelian Online</h2>
        <form id="online-sale-form">
            <label for="online-buyer-name">Nama Pembeli:</label>
            <input type="text" id="online-buyer-name" name="buyer_name" required>
            <label for="online-buyer-address">Alamat Pembeli:</label>
            <input type="text" id="online-buyer-address" name="buyer_address" required>
            <label for="online-transfer-date">Tanggal Transfer:</label>
            <input type="date" id="online-transfer-date" name="transfer_date" required>
            <label for="online-book">Kitab:</label>
            <label for="online-quantity">Jumlah:</label>
            <input type="number" id="online-quantity" name="quantity" min="1" value="1" required>
            <select id="online-book" name="book_id" required></select>
            <label for="online-price">Harga Kitab (otomatis):</label>
            <input type="text" id="online-price" disabled>
            <label for="online-ongkir">Ongkir (otomatis):</label>
            <input type="text" id="online-ongkir" value="Rp 15.000" disabled>
            <label for="online-total">Total Harga (otomatis):</label>
            <input type="text" id="online-total" disabled>
            <button type="submit">Tambah Rekap</button>
        </form>
    </div>

    <!-- Riwayat Transaksi -->
    <div class="container">
        <h2>Riwayat Transaksi</h2>
        <div style="display: flex; gap: 1em; margin-bottom: 1em;">
            <a href="/api/export-offline-sales" class="button" style="background-color: #1a73e8;">Export Transaksi Offline</a>
            <a href="/api/export-online-sales" class="button" style="background-color: #28a745;">Export Transaksi Online</a>
        </div>
        <h4>Transaksi Offline</h4>
        <div style="overflow-x: auto;">
            <table id="all-offline-sales">
                <thead><tr><th>Tanggal</th><th>Nama Pembeli</th><th>Asrama</th><th>Alamat</th><th>Kitab</th><th>Jml</th><th>Total Harga</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <hr style="margin: 2em 0;">
        <h4>Transaksi Online</h4>
        <div style="overflow-x: auto;">
            <table id="all-online-sales">
                <thead><tr><th>Tanggal</th><th>Tgl. Transfer</th><th>Nama Pembeli</th><th>Alamat Kirim</th><th>Kitab</th><th>Jumlah</th><th>Ongkir</th><th>Total Harga</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal untuk Edit Kitab -->
    <div id="edit-book-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edit Detail Kitab</h2>
            <form id="edit-book-form" enctype="multipart/form-data">
                <input type="hidden" id="edit-book-id" name="id">
                <input type="hidden" id="existing-image-filename" name="existing_image_filename">
                <label for="edit-book-name">Nama Kitab:</label>
                <input type="text" id="edit-book-name" name="name" required>
                <label for="edit-book-price">Harga Kitab:</label>
                <input type="number" id="edit-book-price" name="price" required>
                <label for="edit-book-availability">Ketersediaan:</label>
                <select id="edit-book-availability" name="availability" required>
                    <option value="Tersedia">Tersedia</option>
                    <option value="Tidak Tersedia">Tidak Tersedia</option>
                </select>
                <label for="edit-book-link-ig">Link Instagram:</label>
                <input type="url" id="edit-book-link-ig" name="link_ig">
                <label for="edit-book-link-wa">Link WhatsApp:</label>
                <input type="url" id="edit-book-link-wa" name="link_wa">
                <label for="edit-book-link-shopee">Link Shopee:</label>
                <input type="url" id="edit-book-link-shopee" name="link_shopee">
                <label for="edit-book-link-tiktok">Link TikTok:</label>
                <input type="url" id="edit-book-link-tiktok" name="link_tiktok">
                <label for="edit-book-image">Ganti Foto Kitab (biarkan kosong jika tidak diubah):</label>
                <input type="file" id="edit-book-image" name="image" accept="image/png, image/jpeg, image/webp">
                <button type="submit">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        const messageDiv = document.getElementById('message');
        const books = [];

        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = '';
            messageDiv.classList.add(type);
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        function updatePriceDisplay() {
            const formatToRupiah = (number) => number !== null && number !== undefined ? `Rp ${number.toLocaleString('id-ID')}` : '';
            
            const selectedOfflineBook = books.find(b => b.id == $('#offline-book').val());
            $('#offline-price').val(selectedOfflineBook ? formatToRupiah(selectedOfflineBook.price) : '');

            const selectedOnlineBook = books.find(b => b.id == $('#online-book').val());
            if (selectedOnlineBook) {
                const quantity = parseInt($('#online-quantity').val()) || 1;
                const ongkir = 15000;
                const total = (selectedOnlineBook.price * quantity) + ongkir;
                
                $('#online-price').val(formatToRupiah(selectedOnlineBook.price));
                $('#online-ongkir').val(formatToRupiah(ongkir));
                $('#online-total').val(formatToRupiah(total));
            } else {
                $('#online-price, #online-ongkir, #online-total').val('');
            }
        }

        async function loadBooksTable() {
            const response = await fetch('/api/books/all');
            const allBooks = await response.json();
            const tableBody = $('#books-table-body');
            tableBody.empty();
            
            allBooks.forEach(book => {
                const formattedPrice = book.price.toLocaleString('id-ID');
                const imageUrl = book.image_filename ? `/uploads/${book.image_filename}` : 'https://placehold.co/60x80/e2e8f0/4a5568?text=No+Img';
                const row = `
                    <tr>
                        <td><img src="${imageUrl}" alt="${book.name}" class="table-image"></td>
                        <td>${book.name}</td>
                        <td>Rp ${formattedPrice}</td>
                        <td>${book.availability}</td>
                        <td>
                            <div class="btn-group">
                                <a href="#" class="button btn-edit" onclick="event.preventDefault(); editBook(${book.id})">Edit</a>
                                <a href="#" class="button btn-danger" onclick="event.preventDefault(); deleteBook(${book.id}, '${book.name.replace(/'/g, "\\'")}')">Hapus</a>
                            </div>
                        </td>
                    </tr>`;
                tableBody.append(row);
            });
        }

        async function loadRecentSales() {
            const offResponse = await fetch('/api/recent-offline-sales');
            const offSales = await offResponse.json();
            const offTbody = $('#all-offline-sales tbody');
            offTbody.empty();
            offSales.forEach(s => {
                offTbody.append(`<tr><td>${s.sale_date_formatted}</td><td>${s.buyer_name}</td><td>${s.dormitory || '-'}</td><td>${s.address || '-'}</td><td>${s.book_name}</td><td>${s.quantity}</td><td>Rp ${s.total_price.toLocaleString('id-ID')}</td></tr>`);
            });

            const onResponse = await fetch('/api/recent-online-sales');
            const onSales = await onResponse.json();
            const onTbody = $('#all-online-sales tbody');
            onTbody.empty();
            onSales.forEach(s => {
                onTbody.append(`<tr><td>${s.sale_date_formatted}</td><td>${s.transfer_date_formatted || '-'}</td><td>${s.buyer_name}</td><td>${s.buyer_address}</td><td>${s.book_name}</td><td>Rp ${s.shipping_cost.toLocaleString('id-ID')}</td><td>Rp ${s.total_price.toLocaleString('id-ID')}</td></tr>`);
            });
        }

        async function editBook(id) {
            const response = await fetch(`/api/book/${id}`);
            if (!response.ok) { alert('Gagal memuat data kitab.'); return; }
            const book = await response.json();

            $('#edit-book-id').val(book.id);
            $('#existing-image-filename').val(book.image_filename || '');
            $('#edit-book-name').val(book.name);
            $('#edit-book-price').val(book.price);
            $('#edit-book-availability').val(book.availability);
            $('#edit-book-link-ig').val(book.link_ig || '');
            $('#edit-book-link-wa').val(book.link_wa || '');
            $('#edit-book-link-shopee').val(book.link_shopee || '');
            $('#edit-book-link-tiktok').val(book.link_tiktok || '');

            $('#edit-book-modal').show();
        }

        async function deleteBook(id, name) {
            const confirmation = prompt(`Untuk konfirmasi, ketik nama kitab yang akan dihapus: "${name}"`);
            if (confirmation === name) {
                const response = await fetch(`/api/delete-book/${id}`, { method: 'POST' });
                const result = await response.json();
                showMessage(result.message || `Error: ${result.error}`, response.ok ? 'success' : 'error');
                if (response.ok) loadInitialData();
            } else if (confirmation !== null) {
                alert("Nama tidak sesuai. Penghapusan dibatalkan.");
            }
        }

        async function loadInitialData() {
            await Promise.all([loadBooksTable(), loadRecentSales()]);

            const bookResponse = await fetch('/api/books');
            const bookData = await bookResponse.json();
            books.length = 0;
            books.push(...bookData);

            const buyerResponse = await fetch('/api/offline-buyers');
            const buyerData = await buyerResponse.json();
            
            const initSelect2 = (selector, data, placeholder, textKey, idKey) => {
                const select = $(selector);
                select.empty().append(new Option(placeholder, ''));
                data.forEach(item => select.append(new Option(item[textKey], item[idKey])));
                select.select2({ placeholder: placeholder, width: '100%' });
            };

            initSelect2('#offline-buyer', buyerData, '-- Pilih Pembeli --', 'name', 'id');
            initSelect2('#offline-book', bookData, '-- Pilih Kitab --', 'name', 'id');
            initSelect2('#online-book', bookData, '-- Pilih Kitab --', 'name', 'id');
            
            updatePriceDisplay();
        }

        $(document).ready(function() {
            loadInitialData();

            $('#offline-book, #online-book').on('select2:select', updatePriceDisplay);

            $('.close-button').on('click', () => $('#edit-book-modal').hide());

            const handleFormSubmit = async (form, url) => {
                const formData = new FormData(form);
                const response = await fetch(url, { method: 'POST', body: formData });
                const result = await response.json();
                showMessage(result.message || `Error: ${result.error}`, response.ok ? 'success' : 'error');
                if (response.ok) {
                    form.reset();
                    $('#edit-book-modal').hide();
                    loadInitialData();
                }
            };

            $('#add-book-form').on('submit', function(e) { e.preventDefault(); handleFormSubmit(this, '/api/add-book'); });
            $('#edit-book-form').on('submit', function(e) { e.preventDefault(); handleFormSubmit(this, '/api/update-book'); });
            $('#import-form').on('submit', function(e) { e.preventDefault(); handleFormSubmit(this, '/api/import-buyers'); });

            const handleRekapSubmit = async (form, url) => {
                const data = Object.fromEntries(new FormData(form).entries());
                const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const result = await response.json();
                showMessage(result.message || `Error: ${result.error}`, response.ok ? 'success' : 'error');
                if (response.ok) {
                    form.reset();
                    $(form).find('select').val(null).trigger('change');
                    loadRecentSales();
                    updatePriceDisplay();
                }
            };

            $('#offline-sale-form').on('submit', function(e) { e.preventDefault(); handleRekapSubmit(this, '/api/add-offline-sale'); });
            $('#online-sale-form').on('submit', function(e) { e.preventDefault(); handleRekapSubmit(this, '/api/add-online-sale'); });
            $('#online-quantity').on('input', updatePriceDisplay);
        });
    </script>
</body>
</html>
