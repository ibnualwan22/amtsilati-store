{% extends 'admin/layout.html' %}

{% block content %}
<section id="dashboard-section" class="content-section active">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Selamat datang kembali di panel administrasi</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <h3>Total Kitab</h3>
                    <div class="stat-value" id="totalBooks">0</div>
                </div>
                <div class="stat-icon"><i class="fas fa-book"></i></div>
            </div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-header">
                <div>
                    <h3 id="offlineStatTitle">Penjualan Offline</h3>
                    <div class="stat-value" id="totalOfflineSales">Rp 0</div>
                    <div class="stat-change">Pendapatan bulan ini</div>
                </div>
                <div class="stat-icon"><i class="fas fa-store"></i></div>
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-header">
                <div>
                    <h3 id="onlineStatTitle">Penjualan Online</h3>
                    <div class="stat-value" id="totalOnlineSales">Rp 0</div>
                    <div class="stat-change">Pendapatan bulan ini</div>
                </div>
                <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
            </div>
        </div>
        
        <div class="stat-card info" id="shippingStatCard">
            <div class="stat-header">
                <div>
                    <h3 id="shippingStatTitle">Total Ongkir</h3>
                    <div class="stat-value" id="totalShippingCost">Rp 0</div>
                    <div class="stat-change">Biaya pengiriman bulan ini</div>
                </div>
                <div class="stat-icon"><i class="fas fa-shipping-fast"></i></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> Grafik Penjualan</h2>
        </div>
        <div class="card-body">
            <div class="date-filter">
                <label>Dari:</label>
                <input type="date" id="startDate">
                <label>Sampai:</label>
                <input type="date" id="endDate">
                <button class="btn btn-primary" onclick="updateChart()"><i class="fas fa-sync"></i> Update</button>
            </div>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>
</section>
{% endblock %}


{% block scripts %}
<script>
    /**
     * Mengambil data statistik (total kitab, penjualan) dari API dan menampilkannya.
     */
    async function loadDashboardStats() {
        try {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonthName = monthNames[new Date().getMonth()];
            
            const booksResponse = await fetch('/api/books/all');
            const allBooks = await booksResponse.json();
            $('#totalBooks').text(allBooks.length);

            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const currentMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

            const params = new URLSearchParams({ start_date: currentMonthStart, end_date: currentMonthEnd });

            const offlineResponse = await fetch('/api/recent-offline-sales?' + params.toString());
            const monthlyOfflineSales = await offlineResponse.json();
            const totalOffline = monthlyOfflineSales.reduce((sum, sale) => sum + parseFloat(sale.total_price), 0);
            $('#totalOfflineSales').text(`Rp ${totalOffline.toLocaleString('id-ID')}`);
            
            const onlineResponse = await fetch('/api/recent-online-sales?' + params.toString());
            const monthlyOnlineSales = await onlineResponse.json();
            
            // PERBAIKAN DI SINI: Gunakan parseFloat() saat menjumlahkan
            const totalOnline = monthlyOnlineSales.reduce((sum, sale) => sum + parseFloat(sale.total_price), 0);
            const totalShipping = monthlyOnlineSales.reduce((sum, sale) => sum + parseFloat(sale.shipping_cost), 0);
            $('#totalOnlineSales').text(`Rp ${totalOnline.toLocaleString('id-ID')}`);
            $('#totalShippingCost').text(`Rp ${totalShipping.toLocaleString('id-ID')}`);

        } catch (error) {
            console.error('Error loading dashboard stats:', error);
            showMessage('Gagal memuat statistik dashboard.', 'error');
        }
    }

    /**
     * Menginisialisasi chart kosong dengan TIGA dataset (termasuk Ongkir).
     */
   function initializeChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Penjualan Offline',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }, {
                        label: 'Penjualan Online',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: 'Plus Jakarta Sans',
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#111827',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            boxPadding: 6,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Rp ' + context.parsed.y.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: 'Plus Jakarta Sans',
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                },
                                font: {
                                    family: 'Plus Jakarta Sans',
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            updateChart();
        }

        async function updateChart() {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        if (!startDate || !endDate || !salesChart) return;

        try {
            // 1. Buat parameter filter tanggal
            const params = new URLSearchParams({ start_date: startDate, end_date: endDate });

            // 2. Ambil data offline & online DENGAN filter tanggal
            const [offlineResponse, onlineResponse] = await Promise.all([
                fetch('/api/recent-offline-sales?' + params.toString()),
                fetch('/api/recent-online-sales?' + params.toString())
            ]);
            
            const offlineSales = await offlineResponse.json();
            const onlineSales = await onlineResponse.json();
            
            // 3. Proses data untuk ditampilkan di grafik
            const salesByDate = {};
            const allDates = [];
            let currentDate = new Date(startDate);
            const end = new Date(endDate);

            // Buat daftar semua tanggal dalam rentang yang dipilih
            while (currentDate <= end) {
                const dateStr = currentDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                allDates.push(dateStr);
                salesByDate[dateStr] = { offline: 0, online: 0 };
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Jumlahkan total penjualan offline per tanggal
            offlineSales.forEach(sale => {
                // Ambil tanggal dari 'sale_date_formatted' dan ubah formatnya
                const dateKey = sale.sale_date_formatted.split(' ')[0];
                if (salesByDate[dateKey] !== undefined) {
                    salesByDate[dateKey].offline += parseFloat(sale.total_price); // Gunakan parseFloat
                }
            });

            // Jumlahkan total penjualan online per tanggal
            onlineSales.forEach(sale => {
                const dateKey = sale.sale_date_formatted.split(' ')[0];
                if (salesByDate[dateKey] !== undefined) {
                    salesByDate[dateKey].online += parseFloat(sale.total_price); // Gunakan parseFloat
                }
            });

            // 4. Update data ke dalam Chart.js
            salesChart.data.labels = allDates;
            salesChart.data.datasets[0].data = allDates.map(date => salesByDate[date].offline);
            salesChart.data.datasets[1].data = allDates.map(date => salesByDate[date].online);
            salesChart.update();

        } catch (error) {
            console.error('Error updating chart:', error);
            showMessage('Gagal memuat data grafik.', 'error');
        }
    }


        // Utility functions
       
    
    /**
     * Mengambil data berdasarkan filter tanggal dan memperbarui chart.
     */

    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const lastMonth = new Date(new Date().setMonth(today.getMonth() - 1));
        $('#startDate').val(lastMonth.toISOString().split('T')[0]);
        $('#endDate').val(today.toISOString().split('T')[0]);

        loadDashboardStats();
        initializeChart();
        updateChart();
    });
</script>
{% endblock %}